#!/bin/bash
# 

test_shogun() {
	LD_LIBRARY_PATH=$SHOGUN_PATH matlab -r "addpath $SHOGUN_PATH; try, x = sg('get_version'); fprintf('sg_test_succ'); catch, fprintf('sg_test_failed'); end, exit" | grep "sg_test"
}
## parse parameters
################################################################################
for parm in "$@" ; do
	if test "$parm" = "--help" || test "$parm" = "-help" || test "$parm" = "-h" ; then
		cat << EOF
Configuration:
  -matlab						use matlab interpreter 
  -h, -help, --help             display this help and exit

EOF
		exit 0
	fi
done # for parm in ...

for ac_option do
	case "$ac_option" in
  		-matlab)
		use_matlab=yes;
		;;
		-octave)
		use_octave=yes;
		;;
		*)
		die "Unknown parameter: $ac_option"
		;;
	esac
done


## write mgene_config file
################################################################################
echo '#!/bin/bash' 									> mgene_config.sh
echo 												>> mgene_config.sh
if test "$use_matlab" = yes
then
	echo use matlab interpreter
	echo export INTERPRETER=matlab 					>> mgene_config.sh
	# the binary that is executed when starting matlab
	echo export MATLAB_BIN_PATH=matlab 				>> mgene_config.sh
fi

# path to mgene source code
MGENE_SRC_PATH=`pwd`
echo export MGENE_SRC_PATH=$MGENE_SRC_PATH			>> mgene_config.sh

SHOGUN_PATH=`pwd`/shogun
if ! test -f $SHOGUN_PATH/sg.mexa64
then 
	echo shogun mex file not found
	echo file $SHOGUN_PATH/sg.mexa64 missing
	echo please create a link to the shogun mex file 
else
	#SG_TEST_RES=`LD_LIBRARY_PATH=shogun/ matlab -r "addpath shogun/; try, x = sg('get_version'); fprintf('sg_test_succ'); catch, fprintf('sg_test_failed'); end, exit" | grep "sg_test"`
	SG_TEST_RES=`test_shogun`
	echo $SG_TEST_RES
	if ! test "$SG_TEST_RES" = sg_test_succ
	then 
		echo found shogun mex file, but could not run it \(libraries missing?\)
		ldd $SHOGUN_PATH/sg.mexa64
	fi
fi
echo export SHOGUN_PATH=$SHOGUN_PATH 				>> mgene_config.sh
echo export OCTAVE_BIN_PATH=$OCTAVE_BIN_PATH 		>> mgene_config.sh
echo export OPTIMIZER=$OPTIMIZER 					>> mgene_config.sh
echo export OPTIMIZER_PATH=$OPTIMIZER_PATH 			>> mgene_config.sh
echo export OPTIMIZER_TOOLBOX_PATH=$OPTIMIZER_TOOLBOX_PATH >> mgene_config.sh


